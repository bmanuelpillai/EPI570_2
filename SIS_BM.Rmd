---
title: "SIS Model"
author: "Bevin Manuelpillai"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(pacman)
library(EpiModel)
library(ggplot2)
library(tidyverse)
library(tidyr)
library(reshape2)
```

```{r 3 All or Nothing SIS BEVIN}

AoN <- function(t, t0, parms) {
  with(as.list(c(t0, parms)), {
    # 1.Track the population sizes
        m.num = s.m.num + i.m.num + v.m.num
        f.num = s.f.num + i.f.num + v.f.num
        num = m.num + f.num

    
    # 2. Define Contact Rate based on Sex and symptomatic status. Define contact rate for females based on the contact rate for males. Define contact rate for symptomatic people based on a decreased sexual activity from asymptomatic people of the same sex.
        ce.f <- (ce.m * m.num) / f.num
      # We are isolating to only heterosexual contacts.
      
#Can we make this assumption that the ce would be the same for these other ones
    
   # 3.Define lambda
        #For Males
        lambda.m <- (tau) * (ce.m) * (i.m.num / (s.m.num + v.m.num))

        #For Females
        lambda.f <- (tau) * (ce.f) * (i.f.num / (s.f.num + v.f.num))

# Unsure on this (we have infection probability * contact rate times number of people infected overall???)
    mu <- 1/lifespan
    delta <- 1/dur.inf
    
    # 3.Write six differential equations
    
# MALES
  dSm <- (-lambda.m * s.m.num) + (1 - (mu * m.num * omega.m)) + (delta * i.m.num)  - (mu * s.m.num)

  dIm <- (lambda.m * v.m.num * (1-psi))  + (lambda.m * s.m.num) - (delta * i.m.num)  - (mu * i.m.num)
  
  dVm <- (-lambda.m * v.m.num * (1-psi)) + (omega.m * mu * m.num) - (mu * v.m.num)

# FEMALES
  dSf <- (-lambda.f * s.f.num) + (1 - (mu * f.num * omega.f)) + (delta * i.f.num)  - (mu * s.f.num)

  dIf <- (lambda.f * v.f.num * (1-psi))  + (lambda.f * s.f.num) - (delta * i.f.num)  - (mu * i.f.num)
  
  dVf <- (-lambda.f * v.f.num * (1-psi)) + (omega.f * mu * f.num) - (mu * v.f.num)
    
    # 4.Outputs
    list(c(dSm, dIm,dVm,
            dSf, dIf, dVf,
            si.m.flow = (lambda.m * s.m.num),
            si.f.flow = (lambda.f * s.f.num),
            vi.m.flow = (lambda.m * v.m.num * (1-psi)),
            vi.f.flow = (lambda.f * v.f.num * (1-psi))
       ))
  })
}

param <- param.dcm(omega.m = 0.10, omega.f = 0.40, chi = 0.90, lifespan = (11*365),
                   psi = 0.98, dur.inf = (1.5*365), ce.m = 5, tau = 0.74)

init <- init.dcm(s.m.num = 3800000, i.m.num = 1300000, v.m.num = 304000, si.m.flow = 0,vi.m.flow = 0,
                 s.f.num = 3000000, i.f.num = 2000000, v.f.num = 240000, si.f.flow = 0, vi.f.flow = 0)

control <- control.dcm(nsteps = (11*365), new.mod = AoN)

mod <- dcm(param, init, control)
mod

test <- as.data.frame(mod)
```

```{r}
#Note: Added more code similar to this below, made some modifications which you may find to be easier
# Add number infected and prevalence

# Tom you are the expert outputter so I leave this part to you to fix boss. This is so busted its not even funny

mod <- mutate_epi(mod, m.num = s.m.num + i.m.sy.num + i.m.ay.num + v.m.num, f.num = s.f.num + i.f.sy.num + i.f.ay.num + v.f.num)
mod <- mutate_epi(mod, m.prev = (i.m.sy.num + i.m.ay.num) / m.num, f.prev = (i.f.sy.num + i.f.ay.num) / f.num)


par(mfrow = c(2,2), mar = c(3,3,2,1), mgp = c(2,1,0)) 

plot(mod, y = "m.prev", main = "prev infected males",
legend = "lim", lwd = 1, ylim = c(0, 0.5)) 

plot(mod, y = "f.prev", main = "prev infected females",
legend = "lim", lwd = 1, ylim = c(0, 0.1))
```